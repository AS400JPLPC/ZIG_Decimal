<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>decimal.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg=="/>
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L2"><span class="tok-kw">const</span> utf = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>).unicode;</span>
<span class="line" id="L3"></span>
<span class="line" id="L4"></span>
<span class="line" id="L5"></span>
<span class="line" id="L6"><span class="tok-kw">const</span> c = <span class="tok-builtin">@cImport</span>( { <span class="tok-builtin">@cInclude</span>(<span class="tok-str">&quot;mpdecimal.h&quot;</span>); } );</span>
<span class="line" id="L7"></span>
<span class="line" id="L8"><span class="tok-comment">//---------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L9"><span class="tok-comment">// begin  decimal</span>
</span>
<span class="line" id="L10"><span class="tok-comment">//</span>
</span>
<span class="line" id="L11"><span class="tok-comment">/// https://www.bytereef.org/mpdecimal/index.html </span></span>
<span class="line" id="L12"><span class="tok-comment">/// const c = @cImport( { @cInclude(&quot;mpdecimal.h&quot;); } );</span></span>
<span class="line" id="L13"><span class="tok-comment">/// installation with your package manager or download </span></span>
<span class="line" id="L14"><span class="tok-comment">///</span></span>
<span class="line" id="L15"><span class="tok-comment">/// validated: by https://speleotrove.com/decimal/</span></span>
<span class="line" id="L16"><span class="tok-comment">/// official site thank you for making this standardization available</span></span>
<span class="line" id="L17"><span class="tok-comment">/// </span></span>
<span class="line" id="L18"><span class="tok-comment">/// CTX_ADDR Communication structure for default common control decimal128 -&gt; MPD_ROUND_05UP</span></span>
<span class="line" id="L19"><span class="tok-comment">/// openContex()</span></span>
<span class="line" id="L20"><span class="tok-comment">///</span></span>
<span class="line" id="L21"><span class="tok-comment">/// DCMLFX includes 3 values</span></span>
<span class="line" id="L22"><span class="tok-comment">///       number: mpdecimal structure [*c]</span></span>
<span class="line" id="L23"><span class="tok-comment">///       integer: number of integers in front of the point</span></span>
<span class="line" id="L24"><span class="tok-comment">///       scale: number of integers behind the point</span></span>
<span class="line" id="L25"><span class="tok-comment">///   associated function:</span></span>
<span class="line" id="L26"><span class="tok-comment">///   def: checks the relevance of bounding with mpdecimal and determines the fixed decimal</span></span>
<span class="line" id="L27"><span class="tok-comment">///         Test if the context is active otherwise it calls openContext()</span></span>
<span class="line" id="L28"><span class="tok-comment">///     </span></span>
<span class="line" id="L29"><span class="tok-comment">///   free: frees the associated memory storage &quot;.number&quot; (not the definition)</span></span>
<span class="line" id="L30"><span class="tok-comment">///   debugPrint: small followed by &quot;.number&quot;</span></span>
<span class="line" id="L31"><span class="tok-comment">///   isNumber: check value is compliant '0-9 + - .' compliant SQL postgres DB2...</span></span>
<span class="line" id="L32"><span class="tok-comment">///   isValide: uses isNumber, and checks if the external value  complies with the boundary</span></span>
<span class="line" id="L33"><span class="tok-comment">///   isOverflow: check if the internal value is out of bounds</span></span>
<span class="line" id="L34"><span class="tok-comment">///   assign: give a value (text format) to &quot;.number&quot;</span></span>
<span class="line" id="L35"><span class="tok-comment">///   setZeros: forces the value 0 to &quot;.number&quot;</span></span>
<span class="line" id="L36"><span class="tok-comment">///   isZeros: checks if the value 0</span></span>
<span class="line" id="L37"><span class="tok-comment">///   round: two-function round and truncate (0.5 = +1) see finance...</span></span>
<span class="line" id="L38"><span class="tok-comment">///   trunc: to a function, truncate without rounding</span></span>
<span class="line" id="L39"><span class="tok-comment">///   string: if the scale part is larger than its definition, </span></span>
<span class="line" id="L40"><span class="tok-comment">///           it rounds then adds zeros if necessary (respects the SQL display alignment standard on the left ex: 1.00)</span></span>
<span class="line" id="L41"><span class="tok-comment">///   add: a = a + b</span></span>
<span class="line" id="L42"><span class="tok-comment">///   sub: a = a - b</span></span>
<span class="line" id="L43"><span class="tok-comment">///   mul: a = a * b</span></span>
<span class="line" id="L44"><span class="tok-comment">///   div: a = a / b      if b = zeros raises an error    </span></span>
<span class="line" id="L45"><span class="tok-comment">///   addTo: r = a + b</span></span>
<span class="line" id="L46"><span class="tok-comment">///   subTo: r = a - b</span></span>
<span class="line" id="L47"><span class="tok-comment">///   mulTo: r = a * b</span></span>
<span class="line" id="L48"><span class="tok-comment">///   divto: r = a / b      if b = zeros raises an error</span></span>
<span class="line" id="L49"><span class="tok-comment">///   floor: r = a</span></span>
<span class="line" id="L50"><span class="tok-comment">///   ceil : r = a</span></span>
<span class="line" id="L51"><span class="tok-comment">///   rem  : r = a / b      if b = zeros raises an error</span></span>
<span class="line" id="L52"><span class="tok-comment">///   rate: raises a value with the percentage ex ( n = (val*nbr) , val = (n * %1.25)</span></span>
<span class="line" id="L53"><span class="tok-comment">/// </span></span>
<span class="line" id="L54"><span class="tok-comment">/// function off DCMLF</span></span>
<span class="line" id="L55"><span class="tok-comment">/// cmp: compare a , b returns EQ LT GT</span></span>
<span class="line" id="L56"><span class="tok-comment">/// mdrate module: returns ex: ttc , htx (base val, article nrb, rate = 25 ) practice in 5 operations</span></span>
<span class="line" id="L57"><span class="tok-comment">/// forceAssign: forces the value</span></span>
<span class="line" id="L58"><span class="tok-comment">/// dsperr: practical @panic product in test </span></span>
<span class="line" id="L59"><span class="tok-comment">/// debugContext: print context</span></span>
<span class="line" id="L60"></span>
<span class="line" id="L61"></span>
<span class="line" id="L62"><span class="tok-kw">pub</span> <span class="tok-kw">var</span> CTX_ADDR: c.mpd_context_t = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L63"></span>
<span class="line" id="L64"><span class="tok-kw">var</span> startContext : <span class="tok-type">bool</span> = <span class="tok-null">false</span> ;</span>
<span class="line" id="L65"></span>
<span class="line" id="L66"><span class="tok-kw">const</span> dcmlError = <span class="tok-kw">error</span> {</span>
<span class="line" id="L67">  Failed_Init_iEntier_iScale,</span>
<span class="line" id="L68">  Failed_set_precision_cMaxDigit,</span>
<span class="line" id="L69">  Failed_isNumber_string,</span>
<span class="line" id="L70">  Failed_valid_entier,</span>
<span class="line" id="L71">  Failed_valid_scale,</span>
<span class="line" id="L72">  Failed_valid_dot,</span>
<span class="line" id="L73">  isOverflow_entier,</span>
<span class="line" id="L74">  isOverflow_scale,</span>
<span class="line" id="L75">  isOverflow_entier_htx,</span>
<span class="line" id="L76">  isOverflow_entier_ttc,</span>
<span class="line" id="L77">  div_impossible_zeros,</span>
<span class="line" id="L78">  cmp_impossible</span>
<span class="line" id="L79">};</span>
<span class="line" id="L80"></span>
<span class="line" id="L81"><span class="tok-kw">pub</span> <span class="tok-kw">const</span> dcml = <span class="tok-kw">struct</span>{</span>
<span class="line" id="L82"></span>
<span class="line" id="L83">  <span class="tok-kw">pub</span> <span class="tok-kw">const</span> DCMLFX = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L84">    number  : [*c]c.mpd_t ,     <span class="tok-comment">// number </span>
</span>
<span class="line" id="L85">    entier  : <span class="tok-type">u8</span> ,              <span class="tok-comment">// Left  part of the number</span>
</span>
<span class="line" id="L86">    scale   : <span class="tok-type">u8</span> ,              <span class="tok-comment">// Right part of the number</span>
</span>
<span class="line" id="L87"></span>
<span class="line" id="L88"></span>
<span class="line" id="L89"></span>
<span class="line" id="L90"></span>
<span class="line" id="L91"></span>
<span class="line" id="L92">    <span class="tok-comment">//--------------------------------------------------------------</span>
</span>
<span class="line" id="L93">    <span class="tok-comment">// Definition ex: for management -&gt; accounting, stock, order...</span>
</span>
<span class="line" id="L94">    <span class="tok-comment">//--------------------------------------------------------------</span>
</span>
<span class="line" id="L95">    <span class="tok-comment">// MPD_DECIMAL32 = 32     MPD_ROUND_HALF_EVEN</span>
</span>
<span class="line" id="L96">    <span class="tok-comment">// MPD_DECIMAL64 = 64     MPD_ROUND_HALF_EVEN   </span>
</span>
<span class="line" id="L97">    <span class="tok-comment">// MPD_DECIMAL128 = 128   MPD_ROUND_HALF_EVEN       </span>
</span>
<span class="line" id="L98">    <span class="tok-kw">fn</span> <span class="tok-fn">openContext</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L99">        c.mpd_maxcontext(<span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR) ) ;</span>
<span class="line" id="L100">        _= c.mpd_ieee_context(<span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR) ,<span class="tok-number">128</span>);</span>
<span class="line" id="L101">        startContext = <span class="tok-null">true</span> ;</span>
<span class="line" id="L102">    }</span>
<span class="line" id="L103"></span>
<span class="line" id="L104"></span>
<span class="line" id="L105"></span>
<span class="line" id="L106"></span>
<span class="line" id="L107">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">def</span>( iEntier: <span class="tok-type">u8</span> , iScale : <span class="tok-type">u8</span> ) ! DCMLFX {</span>
<span class="line" id="L108">      <span class="tok-kw">if</span> (!startContext) openContext();</span>
<span class="line" id="L109">      <span class="tok-kw">if</span> ((iEntier + iScale  &gt; c.mpd_getprec(&amp;CTX_ADDR)) <span class="tok-kw">or</span> </span>
<span class="line" id="L110">          ( iEntier == <span class="tok-number">0</span> <span class="tok-kw">and</span> iScale == <span class="tok-number">0</span> ) ) <span class="tok-kw">return</span> dcmlError.Failed_Init_iEntier_iScale;</span>
<span class="line" id="L111">      <span class="tok-kw">var</span> snum  = DCMLFX {</span>
<span class="line" id="L112">        .number = c.mpd_qnew() ,</span>
<span class="line" id="L113">        .entier = iEntier ,</span>
<span class="line" id="L114">        .scale  = iScale</span>
<span class="line" id="L115">      };</span>
<span class="line" id="L116">      c.mpd_set_string(snum.number, <span class="tok-str">&quot;0&quot;</span>, <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR) );</span>
<span class="line" id="L117">      c.mpd_set_flags(snum.number,<span class="tok-number">128</span>);</span>
<span class="line" id="L118">      <span class="tok-kw">return</span> snum;</span>
<span class="line" id="L119">    }</span>
<span class="line" id="L120"></span>
<span class="line" id="L121"></span>
<span class="line" id="L122"></span>
<span class="line" id="L123"></span>
<span class="line" id="L124">    <span class="tok-comment">// Frees the storage memory of DCMLFX.number</span>
</span>
<span class="line" id="L125">    <span class="tok-kw">fn</span> <span class="tok-fn">free</span>(cnbr: DCMLFX) <span class="tok-type">void</span> {</span>
<span class="line" id="L126">      c.mpd_del(cnbr.number);</span>
<span class="line" id="L127">    }</span>
<span class="line" id="L128"></span>
<span class="line" id="L129"></span>
<span class="line" id="L130"></span>
<span class="line" id="L131"></span>
<span class="line" id="L132">    <span class="tok-comment">// debug dcml number, entier,scale</span>
</span>
<span class="line" id="L133">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">debugPrint</span>(cnbr: DCMLFX, txt : []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">void</span> {</span>
<span class="line" id="L134">      std.debug.print(<span class="tok-str">&quot;debug: {s} --&gt; dcml:{s} entier:{d} scale:{d}  \r\n&quot;</span>, .{</span>
<span class="line" id="L135">        txt,</span>
<span class="line" id="L136">        c.mpd_to_eng(cnbr.number, <span class="tok-number">0</span>), cnbr.entier, cnbr.scale });</span>
<span class="line" id="L137">    }</span>
<span class="line" id="L138"></span>
<span class="line" id="L139"></span>
<span class="line" id="L140"></span>
<span class="line" id="L141"></span>
<span class="line" id="L142">    <span class="tok-comment">// Numerical value control</span>
</span>
<span class="line" id="L143">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isNumber</span> ( str :[] <span class="tok-kw">const</span> <span class="tok-type">u8</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L144">      <span class="tok-kw">if</span> (std.mem.eql(<span class="tok-type">u8</span>, str, <span class="tok-str">&quot;&quot;</span>) ) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L145">      <span class="tok-kw">var</span> iter = iteratStr.iterator(str);</span>
<span class="line" id="L146">      <span class="tok-kw">var</span> b: <span class="tok-type">bool</span> = <span class="tok-null">true</span>;</span>
<span class="line" id="L147">      <span class="tok-kw">var</span> p: <span class="tok-type">bool</span> = <span class="tok-null">false</span>;</span>
<span class="line" id="L148">      <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> =<span class="tok-number">0</span>;</span>
<span class="line" id="L149">      <span class="tok-kw">while</span> (iter.next()) |ch| :( i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L150">        <span class="tok-kw">var</span> x = utf.utf8Decode(ch) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L151">        <span class="tok-kw">switch</span> (x) {</span>
<span class="line" id="L152">          <span class="tok-str">'0'</span>...<span class="tok-str">'9'</span> =&gt; <span class="tok-kw">continue</span> ,</span>
<span class="line" id="L153">          <span class="tok-str">'.'</span> =&gt; {</span>
<span class="line" id="L154">                  <span class="tok-kw">if</span> ( p ) b = <span class="tok-null">false</span> </span>
<span class="line" id="L155">                  <span class="tok-kw">else</span> {  p = <span class="tok-null">true</span> ; <span class="tok-kw">continue</span> ; }  <span class="tok-comment">// control is . unique</span>
</span>
<span class="line" id="L156">          },</span>
<span class="line" id="L157">          <span class="tok-str">'-'</span> =&gt; { <span class="tok-kw">if</span> ( i ==  <span class="tok-number">0</span> ) <span class="tok-kw">continue</span> <span class="tok-kw">else</span> b = <span class="tok-null">false</span> ; } ,</span>
<span class="line" id="L158">          <span class="tok-str">'+'</span> =&gt; { <span class="tok-kw">if</span> ( i ==  <span class="tok-number">0</span> ) <span class="tok-kw">continue</span> <span class="tok-kw">else</span> b = <span class="tok-null">false</span> ; } ,</span>
<span class="line" id="L159">          <span class="tok-kw">else</span> =&gt; b = <span class="tok-null">false</span> ,</span>
<span class="line" id="L160">        }</span>
<span class="line" id="L161">      }</span>
<span class="line" id="L162">      <span class="tok-kw">return</span> b;</span>
<span class="line" id="L163">    }</span>
<span class="line" id="L164"></span>
<span class="line" id="L165"></span>
<span class="line" id="L166"></span>
<span class="line" id="L167"></span>
<span class="line" id="L168">    <span class="tok-comment">// Validity check</span>
</span>
<span class="line" id="L169">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isValid</span> (cnbr: DCMLFX, str :[] <span class="tok-kw">const</span> <span class="tok-type">u8</span>) ! <span class="tok-type">void</span> {</span>
<span class="line" id="L170">      <span class="tok-kw">if</span> (!isNumber(str)) <span class="tok-kw">return</span> dcmlError.Failed_isNumber_string;</span>
<span class="line" id="L171">      <span class="tok-kw">var</span> iter = iteratStr.iterator(str);</span>
<span class="line" id="L172">      <span class="tok-kw">var</span> e: <span class="tok-type">usize</span> = <span class="tok-number">0</span> ;    <span class="tok-comment">// nbr carctère entier</span>
</span>
<span class="line" id="L173">      <span class="tok-kw">var</span> s: <span class="tok-type">usize</span> = <span class="tok-number">0</span> ;    <span class="tok-comment">// nbr carctère scale</span>
</span>
<span class="line" id="L174">      <span class="tok-kw">var</span> p: <span class="tok-type">bool</span> =<span class="tok-null">false</span>;   <span class="tok-comment">// '.' </span>
</span>
<span class="line" id="L175">      <span class="tok-kw">while</span> (iter.next()) |ch|  {</span>
<span class="line" id="L176">        <span class="tok-kw">var</span> x = utf.utf8Decode(ch) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L177">        <span class="tok-kw">switch</span> (x) {</span>
<span class="line" id="L178">          <span class="tok-str">'0'</span>...<span class="tok-str">'9'</span> =&gt;  { <span class="tok-kw">if</span> (!p ) e += <span class="tok-number">1</span> </span>
<span class="line" id="L179">                          <span class="tok-kw">else</span> s += <span class="tok-number">1</span>;</span>
<span class="line" id="L180">                        },</span>
<span class="line" id="L181">          <span class="tok-str">'.'</span> =&gt; p = <span class="tok-null">true</span>,</span>
<span class="line" id="L182">          <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L183">        }</span>
<span class="line" id="L184">      }</span>
<span class="line" id="L185">      <span class="tok-kw">if</span> (cnbr.entier &lt; e) <span class="tok-kw">return</span> dcmlError.Failed_valid_entier;</span>
<span class="line" id="L186">      <span class="tok-kw">if</span> (cnbr.scale  &lt; s) <span class="tok-kw">return</span> dcmlError.Failed_valid_scale;</span>
<span class="line" id="L187">      <span class="tok-kw">if</span> (p <span class="tok-kw">and</span> s == <span class="tok-number">0</span>)    <span class="tok-kw">return</span> dcmlError.Failed_valid_dot;</span>
<span class="line" id="L188">      <span class="tok-kw">return</span> ;</span>
<span class="line" id="L189">    }</span>
<span class="line" id="L190"></span>
<span class="line" id="L191"></span>
<span class="line" id="L192"></span>
<span class="line" id="L193"></span>
<span class="line" id="L194">    <span class="tok-comment">// Validity check Overflow</span>
</span>
<span class="line" id="L195">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isOverflow</span> (cnbr: DCMLFX) ! <span class="tok-type">void</span> {</span>
<span class="line" id="L196">      <span class="tok-kw">var</span> str = std.mem.span(c.mpd_to_eng(cnbr.number, <span class="tok-number">0</span>));</span>
<span class="line" id="L197"></span>
<span class="line" id="L198">      <span class="tok-kw">var</span> iter = iteratStr.iterator(str);</span>
<span class="line" id="L199">      <span class="tok-kw">var</span> e: <span class="tok-type">usize</span> = <span class="tok-number">0</span> ;    <span class="tok-comment">// nbr carctère entier</span>
</span>
<span class="line" id="L200">      <span class="tok-kw">var</span> s: <span class="tok-type">usize</span> = <span class="tok-number">0</span> ;    <span class="tok-comment">// nbr carctère scale</span>
</span>
<span class="line" id="L201">      <span class="tok-kw">var</span> p: <span class="tok-type">bool</span> =<span class="tok-null">false</span>;   <span class="tok-comment">// '.' </span>
</span>
<span class="line" id="L202">      <span class="tok-kw">while</span> (iter.next()) |ch|  {</span>
<span class="line" id="L203">        <span class="tok-kw">var</span> x = utf.utf8Decode(ch) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L204">        <span class="tok-kw">switch</span> (x) {</span>
<span class="line" id="L205">          <span class="tok-str">'0'</span>...<span class="tok-str">'9'</span> =&gt;  { <span class="tok-kw">if</span> (!p ) e += <span class="tok-number">1</span> </span>
<span class="line" id="L206">                          <span class="tok-kw">else</span> s += <span class="tok-number">1</span>;</span>
<span class="line" id="L207">                        },</span>
<span class="line" id="L208">          <span class="tok-str">'.'</span> =&gt; p = <span class="tok-null">true</span>,</span>
<span class="line" id="L209">          <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L210">        }</span>
<span class="line" id="L211">      }</span>
<span class="line" id="L212">      <span class="tok-kw">if</span> (cnbr.entier &lt; e) <span class="tok-kw">return</span> dcmlError.isOverflow_entier;</span>
<span class="line" id="L213">      <span class="tok-kw">if</span> (cnbr.scale  &lt; s) <span class="tok-kw">return</span> dcmlError.isOverflow_scale;</span>
<span class="line" id="L214">    }</span>
<span class="line" id="L215"></span>
<span class="line" id="L216"></span>
<span class="line" id="L217"></span>
<span class="line" id="L218"></span>
<span class="line" id="L219">    <span class="tok-comment">// value assignment  </span>
</span>
<span class="line" id="L220">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">assign</span>(cnbr: DCMLFX, str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>)  ! <span class="tok-type">void</span> {</span>
<span class="line" id="L221">      <span class="tok-kw">const</span> allocator = std.heap.page_allocator;</span>
<span class="line" id="L222">      isValid(cnbr, str) <span class="tok-kw">catch</span> | err | {<span class="tok-kw">return</span> err ;} ;</span>
<span class="line" id="L223">      <span class="tok-kw">const</span> sVal = allocator.alloc(<span class="tok-type">u8</span>, str.len ) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L224">      std.mem.copy(<span class="tok-type">u8</span>, sVal, str);</span>
<span class="line" id="L225">      c.mpd_set_string(cnbr.number, <span class="tok-builtin">@ptrCast</span>(*<span class="tok-type">u8</span>,sVal), <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR) );</span>
<span class="line" id="L226">    }</span>
<span class="line" id="L227"></span>
<span class="line" id="L228"></span>
<span class="line" id="L229"></span>
<span class="line" id="L230"></span>
<span class="line" id="L231">    <span class="tok-comment">// set &quot;0&quot; </span>
</span>
<span class="line" id="L232">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">setZeros</span>(cnbr: DCMLFX) <span class="tok-type">void</span> {</span>
<span class="line" id="L233">      c.mpd_set_string(cnbr.number, <span class="tok-builtin">@ptrCast</span>([*c] <span class="tok-kw">const</span> <span class="tok-type">u8</span>,<span class="tok-str">&quot;0&quot;</span>), <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR) );</span>
<span class="line" id="L234">    }</span>
<span class="line" id="L235"></span>
<span class="line" id="L236"></span>
<span class="line" id="L237"></span>
<span class="line" id="L238"></span>
<span class="line" id="L239">    <span class="tok-comment">// isZeros </span>
</span>
<span class="line" id="L240">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">isZeros</span>(cnbr: DCMLFX) <span class="tok-type">bool</span>{</span>
<span class="line" id="L241">      <span class="tok-kw">if</span> ( <span class="tok-number">1</span> == c.mpd_iszero(cnbr.number)) <span class="tok-kw">return</span> <span class="tok-null">true</span> </span>
<span class="line" id="L242">      <span class="tok-kw">else</span> <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L243">    }</span>
<span class="line" id="L244"></span>
<span class="line" id="L245"></span>
<span class="line" id="L246"></span>
<span class="line" id="L247"></span>
<span class="line" id="L248">    <span class="tok-comment">// ARRONDI comptable / commercial</span>
</span>
<span class="line" id="L249">    <span class="tok-comment">// round and truncate  5 =&gt; + 1</span>
</span>
<span class="line" id="L250">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">round</span>(cnbr: DCMLFX) <span class="tok-type">void</span> {</span>
<span class="line" id="L251">      <span class="tok-kw">var</span> r: [*c]c.mpd_t = c.mpd_qnew();</span>
<span class="line" id="L252">      <span class="tok-kw">var</span> i : <span class="tok-type">usize</span> = <span class="tok-number">1</span>;</span>
<span class="line" id="L253">      <span class="tok-kw">var</span> m: <span class="tok-type">c_int</span> = <span class="tok-number">10</span>;</span>
<span class="line" id="L254">      c.mpd_copy(r , cnbr.number , <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L255">      <span class="tok-kw">if</span> (cnbr.scale &gt; <span class="tok-number">0</span>){</span>
<span class="line" id="L256">        <span class="tok-kw">while</span>( i &lt;= cnbr.scale) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L257">          c.mpd_mul_i32(r , r, m ,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L258">        }</span>
<span class="line" id="L259">        i = <span class="tok-number">1</span>;</span>
<span class="line" id="L260">        c.mpd_round_to_int(r , r,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L261">        <span class="tok-kw">while</span>( i &lt;= cnbr.scale) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L262">          c.mpd_div_i32(r , r, m ,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L263">        }</span>
<span class="line" id="L264">      }</span>
<span class="line" id="L265">      <span class="tok-kw">else</span> c.mpd_floor(r , r,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L266">      c.mpd_copy(cnbr.number , r,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L267">    }</span>
<span class="line" id="L268"></span>
<span class="line" id="L269"></span>
<span class="line" id="L270"></span>
<span class="line" id="L271"></span>
<span class="line" id="L272"></span>
<span class="line" id="L273">    <span class="tok-comment">// truncate without rounding </span>
</span>
<span class="line" id="L274">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">trunc</span>(cnbr: DCMLFX) <span class="tok-type">void</span> {</span>
<span class="line" id="L275">      <span class="tok-kw">var</span> r: [*c]c.mpd_t = c.mpd_qnew();</span>
<span class="line" id="L276">      <span class="tok-kw">var</span> i : <span class="tok-type">usize</span> = <span class="tok-number">1</span>;</span>
<span class="line" id="L277">      <span class="tok-kw">var</span> m: <span class="tok-type">c_int</span> = <span class="tok-number">10</span>;</span>
<span class="line" id="L278">      c.mpd_copy(r , cnbr.number , <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L279">      <span class="tok-kw">if</span> (cnbr.scale &gt; <span class="tok-number">0</span>){</span>
<span class="line" id="L280">        <span class="tok-kw">while</span>( i &lt;= cnbr.scale) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L281">          c.mpd_mul_i32(r , r, m ,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L282">        }</span>
<span class="line" id="L283">        i = <span class="tok-number">1</span>;</span>
<span class="line" id="L284">        c.mpd_trunc(r , r,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L285">        <span class="tok-kw">while</span>( i &lt;= cnbr.scale) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L286">          c.mpd_div_i32(r , r, m ,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L287">        }</span>
<span class="line" id="L288">      }</span>
<span class="line" id="L289">      <span class="tok-kw">else</span> c.mpd_floor(r , r,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L290">      c.mpd_copy(cnbr.number , r,  <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR));</span>
<span class="line" id="L291">    }</span>
<span class="line" id="L292"></span>
<span class="line" id="L293"></span>
<span class="line" id="L294"></span>
<span class="line" id="L295"></span>
<span class="line" id="L296">    <span class="tok-comment">// Returns a formatted string for gestion, statistique ...</span>
</span>
<span class="line" id="L297">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">string</span>(cnbr: DCMLFX ) [] <span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L298">      <span class="tok-comment">// attention output [*c]</span>
</span>
<span class="line" id="L299">      <span class="tok-kw">var</span> cstring = c.mpd_to_eng(cnbr.number, <span class="tok-number">0</span>);</span>
<span class="line" id="L300">      <span class="tok-comment">// convetion from [*c] to [] const u8 </span>
</span>
<span class="line" id="L301">      <span class="tok-kw">var</span> str  = std.mem.span(cstring);</span>
<span class="line" id="L302"></span>
<span class="line" id="L303">      <span class="tok-kw">var</span> iter = iteratStr.iterator(str);</span>
<span class="line" id="L304">      <span class="tok-kw">var</span> s: <span class="tok-type">usize</span> = <span class="tok-number">0</span> ;    <span class="tok-comment">// nbr carctère scale</span>
</span>
<span class="line" id="L305">      <span class="tok-kw">var</span> p: <span class="tok-type">bool</span> =<span class="tok-null">false</span>;   <span class="tok-comment">// '.' </span>
</span>
<span class="line" id="L306">      <span class="tok-kw">while</span> (iter.next()) |ch|  {</span>
<span class="line" id="L307">        <span class="tok-kw">var</span> x = utf.utf8Decode(ch) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L308">        <span class="tok-kw">switch</span> (x) {</span>
<span class="line" id="L309">          <span class="tok-str">'0'</span>...<span class="tok-str">'9'</span> =&gt;  { <span class="tok-kw">if</span> (p ) s += <span class="tok-number">1</span> ; },</span>
<span class="line" id="L310">          <span class="tok-str">'.'</span> =&gt; p = <span class="tok-null">true</span>,</span>
<span class="line" id="L311">          <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L312">        }</span>
<span class="line" id="L313">      }</span>
<span class="line" id="L314"></span>
<span class="line" id="L315">      <span class="tok-kw">if</span> ( s &gt; cnbr.scale ) { </span>
<span class="line" id="L316">        cnbr.round(); </span>
<span class="line" id="L317">        str  = std.mem.span(c.mpd_to_eng(cnbr.number, <span class="tok-number">0</span>));</span>
<span class="line" id="L318">        iter = iteratStr.iterator(str);</span>
<span class="line" id="L319">        s = <span class="tok-number">0</span> ;  </span>
<span class="line" id="L320">        p =<span class="tok-null">false</span>;   </span>
<span class="line" id="L321">        <span class="tok-kw">while</span> (iter.next()) |ch|  {</span>
<span class="line" id="L322">          <span class="tok-kw">var</span> x = utf.utf8Decode(ch) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L323"></span>
<span class="line" id="L324">          <span class="tok-kw">switch</span> (x) {</span>
<span class="line" id="L325">            <span class="tok-str">'0'</span>...<span class="tok-str">'9'</span> =&gt;  { <span class="tok-kw">if</span> (p ) s += <span class="tok-number">1</span> ; },</span>
<span class="line" id="L326">            <span class="tok-str">'.'</span> =&gt; p = <span class="tok-null">true</span>,</span>
<span class="line" id="L327">            <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L328">          }</span>
<span class="line" id="L329">        }</span>
<span class="line" id="L330">      }</span>
<span class="line" id="L331">      <span class="tok-kw">if</span> ( cnbr.scale &gt; <span class="tok-number">0</span> ) {</span>
<span class="line" id="L332">        <span class="tok-kw">var</span> n : <span class="tok-type">usize</span> = cnbr.scale - s;</span>
<span class="line" id="L333">        <span class="tok-kw">const</span> allocator = std.heap.page_allocator;</span>
<span class="line" id="L334">        <span class="tok-kw">var</span> buf = std.fmt.allocPrint(allocator,<span class="tok-str">&quot;{s}&quot;</span>, .{str}) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L335"></span>
<span class="line" id="L336">        <span class="tok-kw">if</span> (!p) buf = std.fmt.allocPrint(allocator,<span class="tok-str">&quot;{s}.&quot;</span>, .{buf}) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L337"></span>
<span class="line" id="L338">        <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L339">            <span class="tok-kw">if</span> (n == <span class="tok-number">0</span>) <span class="tok-kw">break</span>;</span>
<span class="line" id="L340">            buf = std.fmt.allocPrint(allocator,<span class="tok-str">&quot;{s}0&quot;</span>, .{buf}) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L341">            n -= <span class="tok-number">1</span>;</span>
<span class="line" id="L342">        }</span>
<span class="line" id="L343">        <span class="tok-kw">return</span> buf;</span>
<span class="line" id="L344">      }</span>
<span class="line" id="L345">      <span class="tok-kw">else</span> <span class="tok-kw">return</span> str ;</span>
<span class="line" id="L346">    }</span>
<span class="line" id="L347"></span>
<span class="line" id="L348"></span>
<span class="line" id="L349"></span>
<span class="line" id="L350"></span>
<span class="line" id="L351">    <span class="tok-comment">// function ADD</span>
</span>
<span class="line" id="L352">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">add</span>(a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L353">      <span class="tok-kw">if</span>( a.isZeros()) {a.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L354">      c.mpd_add(a.number, a.number, b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L355">      a.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L356">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L357">      } ;</span>
<span class="line" id="L358">    }</span>
<span class="line" id="L359"></span>
<span class="line" id="L360"></span>
<span class="line" id="L361"></span>
<span class="line" id="L362"></span>
<span class="line" id="L363">    <span class="tok-comment">// function ADD</span>
</span>
<span class="line" id="L364">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">addTo</span>(r: DCMLFX , a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L365">      <span class="tok-kw">if</span>( a.isZeros()) {r.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L366">      c.mpd_add(r.number, a.number, b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L367">      r.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L368">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L369">      } ;</span>
<span class="line" id="L370">    }</span>
<span class="line" id="L371"></span>
<span class="line" id="L372"></span>
<span class="line" id="L373"></span>
<span class="line" id="L374"></span>
<span class="line" id="L375">    <span class="tok-comment">// function SUB</span>
</span>
<span class="line" id="L376">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">sub</span>(a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L377">      <span class="tok-kw">if</span>( a.isZeros()) {a.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L378">      c.mpd_sub(a.number, a.number, b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L379">      a.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L380">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L381">      } ;</span>
<span class="line" id="L382">    }</span>
<span class="line" id="L383"></span>
<span class="line" id="L384"></span>
<span class="line" id="L385"></span>
<span class="line" id="L386"></span>
<span class="line" id="L387">    <span class="tok-comment">// function SUB</span>
</span>
<span class="line" id="L388">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">subTo</span>(r: DCMLFX ,a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L389">      <span class="tok-kw">if</span>( a.isZeros()) {r.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L390">      c.mpd_sub(r.number, a.number, b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L391">      r.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L392">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L393">      } ;</span>
<span class="line" id="L394">    }</span>
<span class="line" id="L395"></span>
<span class="line" id="L396"></span>
<span class="line" id="L397"></span>
<span class="line" id="L398"></span>
<span class="line" id="L399">    <span class="tok-comment">// function mult</span>
</span>
<span class="line" id="L400">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mul</span>(a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L401">      <span class="tok-kw">if</span>( a.isZeros()) {a.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L402">      c.mpd_mul(a.number, a.number, b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L403">      a.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L404">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L405">      } ;</span>
<span class="line" id="L406">    }</span>
<span class="line" id="L407"></span>
<span class="line" id="L408"></span>
<span class="line" id="L409"></span>
<span class="line" id="L410"></span>
<span class="line" id="L411">    <span class="tok-comment">// function mult</span>
</span>
<span class="line" id="L412">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mulTo</span>(r: DCMLFX ,a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L413">      <span class="tok-kw">if</span>( a.isZeros()) {r.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L414">      c.mpd_mul(r.number, a.number, b.number, &amp;CTX_ADDR,);</span>
<span class="line" id="L415">      r.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L416">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L417">      } ;</span>
<span class="line" id="L418">    }</span>
<span class="line" id="L419"></span>
<span class="line" id="L420"></span>
<span class="line" id="L421"></span>
<span class="line" id="L422"></span>
<span class="line" id="L423">    <span class="tok-comment">// function div</span>
</span>
<span class="line" id="L424">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">div</span>(a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L425">      <span class="tok-kw">if</span>( b.isZeros()) <span class="tok-kw">return</span> dcmlError.div_impossible_zeros;</span>
<span class="line" id="L426">      <span class="tok-kw">if</span>( a.isZeros()) {a.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L427">      c.mpd_div(a.number, a.number, b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L428">      a.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L429">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L430">      } ;</span>
<span class="line" id="L431">    }</span>
<span class="line" id="L432"></span>
<span class="line" id="L433"></span>
<span class="line" id="L434"></span>
<span class="line" id="L435"></span>
<span class="line" id="L436">    <span class="tok-comment">// function mult</span>
</span>
<span class="line" id="L437">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">divTo</span>(r: DCMLFX ,a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L438">      <span class="tok-kw">if</span>( b.isZeros()) <span class="tok-kw">return</span> dcmlError.div_impossible_zeros;</span>
<span class="line" id="L439">      <span class="tok-kw">if</span>( a.isZeros()) {r.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L440">      c.mpd_mul(r.number, a.number, b.number, &amp;CTX_ADDR,);</span>
<span class="line" id="L441">      r.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L442">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L443">      } ;</span>
<span class="line" id="L444">    }</span>
<span class="line" id="L445"></span>
<span class="line" id="L446"></span>
<span class="line" id="L447"></span>
<span class="line" id="L448"></span>
<span class="line" id="L449">    <span class="tok-comment">// function Floor</span>
</span>
<span class="line" id="L450">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">floor</span>(r: DCMLFX ,a: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L451">      <span class="tok-kw">if</span>( a.isZeros()) {r.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L452">      c.mpd_floor(r.number, a.number,  &amp;CTX_ADDR);</span>
<span class="line" id="L453">      r.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L454">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L455">      } ;</span>
<span class="line" id="L456">    }</span>
<span class="line" id="L457"></span>
<span class="line" id="L458"></span>
<span class="line" id="L459"></span>
<span class="line" id="L460"></span>
<span class="line" id="L461">    <span class="tok-comment">// function ceiling</span>
</span>
<span class="line" id="L462">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">ceil</span>(r: DCMLFX ,a: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L463">      <span class="tok-kw">if</span>( a.isZeros()) {r.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L464">      c.mpd_ceil(r.number, a.number,  &amp;CTX_ADDR);</span>
<span class="line" id="L465">      r.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L466">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L467">      } ;</span>
<span class="line" id="L468">    }</span>
<span class="line" id="L469"></span>
<span class="line" id="L470"></span>
<span class="line" id="L471"></span>
<span class="line" id="L472">    <span class="tok-comment">// function remainder</span>
</span>
<span class="line" id="L473">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rem</span>(r: DCMLFX ,a: DCMLFX ,b: DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L474">      <span class="tok-kw">if</span>( b.isZeros()) <span class="tok-kw">return</span> dcmlError.div_impossible_zeros;</span>
<span class="line" id="L475">      <span class="tok-kw">if</span>( a.isZeros()) {r.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L476">      c.mpd_rem(r.number, a.number, b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L477">      r.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L478">        <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L479">      } ;</span>
<span class="line" id="L480">    }</span>
<span class="line" id="L481"></span>
<span class="line" id="L482"></span>
<span class="line" id="L483"></span>
<span class="line" id="L484"></span>
<span class="line" id="L485">    <span class="tok-comment">// function val * nbr * coef   1*x * 1.25</span>
</span>
<span class="line" id="L486">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">rate</span>(res: DCMLFX ,val: DCMLFX , nbr: DCMLFX, coef:DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L487">      <span class="tok-kw">if</span>( val.isZeros()) {res.setZeros() ; <span class="tok-kw">return</span> ;}</span>
<span class="line" id="L488">      <span class="tok-comment">// total htx</span>
</span>
<span class="line" id="L489">      c.mpd_mul(res.number,val.number, nbr.number, &amp;CTX_ADDR);</span>
<span class="line" id="L490">      <span class="tok-comment">// total ttc</span>
</span>
<span class="line" id="L491">      c.mpd_mul(res.number,res.number, coef.number, &amp;CTX_ADDR);</span>
<span class="line" id="L492"></span>
<span class="line" id="L493">    }</span>
<span class="line" id="L494"></span>
<span class="line" id="L495"></span>
<span class="line" id="L496"></span>
<span class="line" id="L497"></span>
<span class="line" id="L498">    <span class="tok-comment">// compare a , b returns EQ LT GT</span>
</span>
<span class="line" id="L499">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">cmp</span>(a: DCMLFX ,b: DCMLFX) ! CMP  {</span>
<span class="line" id="L500"></span>
<span class="line" id="L501">    <span class="tok-kw">var</span> rep :  <span class="tok-type">c_int</span>  = c.mpd_cmp(a.number ,b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L502">      <span class="tok-kw">switch</span> (rep) {</span>
<span class="line" id="L503">          -<span class="tok-number">1</span> =&gt; <span class="tok-kw">return</span> CMP.LT ,</span>
<span class="line" id="L504">          <span class="tok-number">0</span>  =&gt; <span class="tok-kw">return</span> CMP.EQ ,</span>
<span class="line" id="L505">          <span class="tok-number">1</span>  =&gt; <span class="tok-kw">return</span> CMP.GT ,</span>
<span class="line" id="L506">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> dcmlError.cmp_impossible,</span>
<span class="line" id="L507">      }</span>
<span class="line" id="L508">    }</span>
<span class="line" id="L509">  };</span>
<span class="line" id="L510"></span>
<span class="line" id="L511">  <span class="tok-kw">pub</span> <span class="tok-kw">const</span> CMP = <span class="tok-kw">enum</span> (<span class="tok-type">i8</span>) {</span>
<span class="line" id="L512">          LT = -<span class="tok-number">1</span> ,</span>
<span class="line" id="L513">          EQ = <span class="tok-number">0</span>  ,</span>
<span class="line" id="L514">          GT = <span class="tok-number">1</span>  ,</span>
<span class="line" id="L515">  };</span>
<span class="line" id="L516">      <span class="tok-comment">// compare a , b returns EQ LT GT</span>
</span>
<span class="line" id="L517">  <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">cmp</span>(a: DCMLFX ,b: DCMLFX) ! CMP  {</span>
<span class="line" id="L518"></span>
<span class="line" id="L519">    <span class="tok-kw">var</span> rep :  <span class="tok-type">c_int</span>  = c.mpd_cmp(a.number ,b.number, &amp;CTX_ADDR);</span>
<span class="line" id="L520">      <span class="tok-kw">switch</span> (rep) {</span>
<span class="line" id="L521">          -<span class="tok-number">1</span> =&gt; <span class="tok-kw">return</span> CMP.LT ,</span>
<span class="line" id="L522">          <span class="tok-number">0</span>  =&gt; <span class="tok-kw">return</span> CMP.EQ ,</span>
<span class="line" id="L523">          <span class="tok-number">1</span>  =&gt; <span class="tok-kw">return</span> CMP.GT ,</span>
<span class="line" id="L524">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> dcmlError.cmp_impossible,</span>
<span class="line" id="L525">      }</span>
<span class="line" id="L526">  }</span>
<span class="line" id="L527"></span>
<span class="line" id="L528">  <span class="tok-comment">// module rate  htx= (val * nbr) ttc = (htx/∕100) * 25 ) + htx</span>
</span>
<span class="line" id="L529">  <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">mdrate</span>(resttc: DCMLFX ,reshtx: DCMLFX ,val: DCMLFX ,nbr: DCMLFX, coef:DCMLFX) !<span class="tok-type">void</span> {</span>
<span class="line" id="L530">    <span class="tok-kw">if</span>( val.isZeros() <span class="tok-kw">or</span> val.isZeros() <span class="tok-kw">or</span> coef.isZeros()) {resttc.setZeros() ; reshtx.setZeros() ;<span class="tok-kw">return</span> ;}</span>
<span class="line" id="L531"></span>
<span class="line" id="L532">    <span class="tok-kw">var</span> cent: [*c]c.mpd_t = c.mpd_qnew();</span>
<span class="line" id="L533">    c.mpd_set_string(cent, <span class="tok-builtin">@ptrCast</span>([*c] <span class="tok-kw">const</span> <span class="tok-type">u8</span>,<span class="tok-str">&quot;100&quot;</span>), <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR) );</span>
<span class="line" id="L534">    </span>
<span class="line" id="L535">    c.mpd_mul(reshtx.number,val.number, nbr.number, &amp;CTX_ADDR);</span>
<span class="line" id="L536"></span>
<span class="line" id="L537">    c.mpd_div(resttc.number,reshtx.number, cent, &amp;CTX_ADDR);</span>
<span class="line" id="L538"></span>
<span class="line" id="L539">    c.mpd_mul(resttc.number,resttc.number, coef.number, &amp;CTX_ADDR);</span>
<span class="line" id="L540"></span>
<span class="line" id="L541">    c.mpd_add(resttc.number,resttc.number, reshtx.number, &amp;CTX_ADDR);</span>
<span class="line" id="L542"></span>
<span class="line" id="L543">    reshtx.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L544">      <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier_htx) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L545">    } ;</span>
<span class="line" id="L546"></span>
<span class="line" id="L547">    resttc.isOverflow() <span class="tok-kw">catch</span> | err | {</span>
<span class="line" id="L548">      <span class="tok-kw">if</span> (err == dcmlError.isOverflow_entier_ttc) <span class="tok-kw">return</span> err ;</span>
<span class="line" id="L549">    } ;</span>
<span class="line" id="L550">  }</span>
<span class="line" id="L551"></span>
<span class="line" id="L552"></span>
<span class="line" id="L553"></span>
<span class="line" id="L554"></span>
<span class="line" id="L555">  <span class="tok-comment">// force value assignment  </span>
</span>
<span class="line" id="L556">  <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">forceAssign</span>(cnbr: DCMLFX, str: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>)  ! <span class="tok-type">void</span> {</span>
<span class="line" id="L557">    <span class="tok-kw">if</span> (!dcml.DCMLFX.isNumber(str)) <span class="tok-kw">return</span> dcmlError.Failed_isNumber_string;</span>
<span class="line" id="L558">    <span class="tok-kw">const</span> allocator = std.heap.page_allocator;</span>
<span class="line" id="L559">    <span class="tok-kw">const</span> sVal = allocator.alloc(<span class="tok-type">u8</span>, str.len ) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L560">    std.mem.copy(<span class="tok-type">u8</span>, sVal, str);</span>
<span class="line" id="L561">    c.mpd_set_string(cnbr.number, <span class="tok-builtin">@ptrCast</span>(*<span class="tok-type">u8</span>,sVal), <span class="tok-builtin">@ptrCast</span>([*c]c.mpd_context_t, &amp;CTX_ADDR) );</span>
<span class="line" id="L562">  }</span>
<span class="line" id="L563"></span>
<span class="line" id="L564"></span>
<span class="line" id="L565"></span>
<span class="line" id="L566"></span>
<span class="line" id="L567">  <span class="tok-comment">// Shows mode debug serious programming errors</span>
</span>
<span class="line" id="L568">  <span class="tok-kw">pub</span> <span class="tok-kw">const</span>  dsperr = <span class="tok-kw">struct</span> {    </span>
<span class="line" id="L569">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">errorDcml</span>(errpgm :<span class="tok-type">anyerror</span> ) <span class="tok-type">void</span> { </span>
<span class="line" id="L570">      <span class="tok-kw">const</span> allocator = std.heap.page_allocator;</span>
<span class="line" id="L571">      <span class="tok-kw">var</span> msgerr:[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> = std.fmt.allocPrint(allocator,<span class="tok-str">&quot;To report: {any} &quot;</span>,.{errpgm }) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>; </span>
<span class="line" id="L572">      <span class="tok-builtin">@panic</span>(msgerr);</span>
<span class="line" id="L573">    }</span>
<span class="line" id="L574">  };</span>
<span class="line" id="L575"></span>
<span class="line" id="L576"></span>
<span class="line" id="L577"></span>
<span class="line" id="L578"></span>
<span class="line" id="L579">  <span class="tok-comment">// debug context</span>
</span>
<span class="line" id="L580">  <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">debugContext</span>() <span class="tok-type">void</span> {</span>
<span class="line" id="L581">    std.debug.print(<span class="tok-str">&quot;{any}\n&quot;</span>, .{CTX_ADDR});</span>
<span class="line" id="L582">  }</span>
<span class="line" id="L583"></span>
<span class="line" id="L584">  <span class="tok-comment">// end decimal</span>
</span>
<span class="line" id="L585">  <span class="tok-comment">//---------------------------------------------------------------------------------</span>
</span>
<span class="line" id="L586"></span>
<span class="line" id="L587"></span>
<span class="line" id="L588"></span>
<span class="line" id="L589">  <span class="tok-comment">//================================</span>
</span>
<span class="line" id="L590">  <span class="tok-comment">// function utilitaire</span>
</span>
<span class="line" id="L591">  <span class="tok-comment">//================================</span>
</span>
<span class="line" id="L592">  <span class="tok-comment">/// Iterator support iteration string</span></span>
<span class="line" id="L593">  <span class="tok-kw">pub</span> <span class="tok-kw">const</span> iteratStr = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L594">    <span class="tok-kw">var</span> strbuf:[] <span class="tok-kw">const</span> <span class="tok-type">u8</span> = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L595">    <span class="tok-kw">var</span> arenastr = std.heap.ArenaAllocator.init(std.heap.page_allocator);</span>
<span class="line" id="L596">    </span>
<span class="line" id="L597">    <span class="tok-comment">//defer arena.deinit();</span>
</span>
<span class="line" id="L598">    <span class="tok-kw">const</span> allocator = arenastr.allocator();</span>
<span class="line" id="L599">    </span>
<span class="line" id="L600">    <span class="tok-comment">/// Errors that may occur when using String</span></span>
<span class="line" id="L601">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> ErrNbrch = <span class="tok-kw">error</span>{</span>
<span class="line" id="L602">        InvalideAllocBuffer,</span>
<span class="line" id="L603">    };</span>
<span class="line" id="L604">    <span class="tok-kw">fn</span> <span class="tok-fn">allocBuffer</span> ( size :<span class="tok-type">usize</span>) ErrNbrch![]<span class="tok-type">u8</span> {</span>
<span class="line" id="L605">      <span class="tok-kw">var</span> buf = allocator.alloc(<span class="tok-type">u8</span>, size) <span class="tok-kw">catch</span> {</span>
<span class="line" id="L606">              <span class="tok-kw">return</span> ErrNbrch.InvalideAllocBuffer;</span>
<span class="line" id="L607">          };</span>
<span class="line" id="L608">      <span class="tok-kw">return</span> buf;</span>
<span class="line" id="L609">    }</span>
<span class="line" id="L610"></span>
<span class="line" id="L611">    <span class="tok-kw">pub</span> <span class="tok-kw">const</span> StringIterator = <span class="tok-kw">struct</span> {</span>
<span class="line" id="L612">        buf: []<span class="tok-type">u8</span> ,</span>
<span class="line" id="L613">        index: <span class="tok-type">usize</span> ,</span>
<span class="line" id="L614"></span>
<span class="line" id="L615">      <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">next</span>(it: *StringIterator) ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L616">        <span class="tok-kw">var</span> optional_buf: ?[]<span class="tok-type">u8</span>  = allocBuffer(strbuf.len) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L617">        it.buf= optional_buf <span class="tok-kw">orelse</span> <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L618">        <span class="tok-kw">var</span> n : <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L619">        <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L620">            <span class="tok-kw">if</span> (n &gt;= strbuf.len) <span class="tok-kw">break</span>;</span>
<span class="line" id="L621">            it.buf[n] = strbuf[n];</span>
<span class="line" id="L622">            n += <span class="tok-number">1</span>;</span>
<span class="line" id="L623">        }</span>
<span class="line" id="L624"></span>
<span class="line" id="L625">        <span class="tok-kw">if</span> (it.index == it.buf.len) <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L626">        <span class="tok-kw">var</span> i = it.index;</span>
<span class="line" id="L627">        it.index += getUTF8Size(it.buf[i]);</span>
<span class="line" id="L628">        <span class="tok-kw">return</span> it.buf[i..it.index];</span>
<span class="line" id="L629">      }</span>
<span class="line" id="L630"></span>
<span class="line" id="L631">      <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">preview</span>(it: *StringIterator) ?[]<span class="tok-kw">const</span> <span class="tok-type">u8</span> {</span>
<span class="line" id="L632">        <span class="tok-kw">var</span> optional_buf: ?[]<span class="tok-type">u8</span>  = allocBuffer(strbuf.len) <span class="tok-kw">catch</span> <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L633">        it.buf= optional_buf <span class="tok-kw">orelse</span> <span class="tok-str">&quot;&quot;</span>;</span>
<span class="line" id="L634">        <span class="tok-kw">var</span> n : <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L635">        <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L636">            <span class="tok-kw">if</span> (n &gt;= strbuf.len) <span class="tok-kw">break</span>;</span>
<span class="line" id="L637">            it.buf[n] = strbuf[n];</span>
<span class="line" id="L638">            n += <span class="tok-number">1</span>;</span>
<span class="line" id="L639">        }</span>
<span class="line" id="L640"></span>
<span class="line" id="L641">        <span class="tok-kw">if</span> (it.index == <span class="tok-number">0</span>) <span class="tok-kw">return</span> <span class="tok-null">null</span>;</span>
<span class="line" id="L642">        <span class="tok-kw">var</span> i = it.buf.len;</span>
<span class="line" id="L643">        it.index -= getUTF8Size(it.buf[i]);</span>
<span class="line" id="L644">        <span class="tok-kw">return</span> it.buf[i..it.index];</span>
<span class="line" id="L645">      }</span>
<span class="line" id="L646">    };</span>
<span class="line" id="L647"></span>
<span class="line" id="L648">    <span class="tok-comment">/// iterator String</span></span>
<span class="line" id="L649">    <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">iterator</span>(str:[] <span class="tok-kw">const</span> <span class="tok-type">u8</span>) StringIterator {</span>
<span class="line" id="L650">      strbuf = str;</span>
<span class="line" id="L651">      <span class="tok-kw">return</span> StringIterator{</span>
<span class="line" id="L652">        .buf = <span class="tok-null">undefined</span>,</span>
<span class="line" id="L653">        .index = <span class="tok-number">0</span>,</span>
<span class="line" id="L654">      };</span>
<span class="line" id="L655">    }</span>
<span class="line" id="L656"></span>
<span class="line" id="L657">    <span class="tok-comment">/// Returns the UTF-8 character's size</span></span>
<span class="line" id="L658">    <span class="tok-kw">fn</span> <span class="tok-fn">getUTF8Size</span>(char: <span class="tok-type">u8</span>) <span class="tok-type">u3</span> {</span>
<span class="line" id="L659">      <span class="tok-kw">return</span> std.unicode.utf8ByteSequenceLength(char) <span class="tok-kw">catch</span> {</span>
<span class="line" id="L660">        <span class="tok-kw">return</span> <span class="tok-number">1</span>;</span>
<span class="line" id="L661">      };</span>
<span class="line" id="L662">    }</span>
<span class="line" id="L663">  };</span>
<span class="line" id="L664"></span>
<span class="line" id="L665">};</span>
</code></pre></body>
</html>